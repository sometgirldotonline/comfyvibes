<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>comfyvibes</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 1,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
    </style>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <iframe src="skies/clouds.html" class="sky" frameborder="0"></iframe>
    <div class="tv">
        <div class="notification visible"></div>
        <div class="pholder">
            <div class="player">
                <div id="player"></div>
            </div>
            <progress class="prog"></progress>
        </div>
        <div class="data"><span class="title">Title Goes Here</span><span class="artist">Artist Goes Here</span></div>
    </div>
    <div class="tv notplayed">
        Choose a playlist using the phone to begin
    </div>
    <div class="remote">
        <div class="statusbar"><span class="time">00:00</span><span class="date">Nov 28</span></div>
        <div class="loader">
            <h1>Loading...</h1>
            <progress></progress>
        </div>
        <div class="fc">
            <div class="alb" style="background-image:var(--alb);"></div>
            <span class="data"><span class="title">Title Goes Here</span><span class="artist">Artist Goes
                    Here</span></span>
            <div class="controls">
                <button class="prevbtn" onclick="player.previousVideo()"><span class="material-symbols-outlined">
                        skip_previous
                    </span></button>
                <button class="ppbtn"
                    onclick="player.getPlayerState() == 1 ? (player.pauseVideo(), onPPause()) : (player.playVideo(), onPPlay())" ><span
                        class="material-symbols-outlined pause-only">play_arrow</span><span
                        class="material-symbols-outlined play-only">pause</span></button>
                <button class="skipbtn" onclick="player.nextVideo()"><span class="material-symbols-outlined">
                        skip_next
                    </span></button>
            </div>
            <br>
            <input type="range" class="prog" min="0" max="100" onchange="player.seekTo(document.querySelector('input.prog').value)">
            00:00 / 00:00
        </div>
        <ul class="playlists">
        </ul>
        <div class="playerbar">
            <div class="alb" style="background-image:var(--alb);"></div>
            <span class="data"><span class="title">Title Goes Here</span><span class="artist">Artist Goes
                    Here</span></span>
            <button class="ppbtn"
                onclick="player.getPlayerState() == 1 ? (player.pauseVideo(), onPPause()) : (player.playVideo(), onPPlay())" ><span
                    class="material-symbols-outlined pause-only">play_arrow</span><span
                    class="material-symbols-outlined play-only">pause</span></button>
            <button class="skipbtn" onclick="player.nextVideo()"><span class="material-symbols-outlined">
                    skip_next
                </span></button>
        </div>
    </div>
    <script>
        // Load YouTube IFrame API asynchronously
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        // Called when API is ready
        function onYouTubeIframeAPIReady() {
            window.player = new YT.Player('player', {
                playerVars: {
                    'playsinline': 1,
                    'controls': 0,
                    'rel': 0,
                    'modestbranding': 1,
                    'origin': window.location.origin,
                    'widget_referrer': window.location.href,
                    'enablejsapi': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onStateChange
                }
            });
        }

        function onPPause(){
                document.querySelector(".pholder").classList.add("paused")
        }
        function onPPlay(){
            document.querySelector(".loader").classList.remove("loading")
                document.querySelector(".pholder").classList.remove("paused")
                if(document.querySelector(".notplayed")){
                    document.querySelector(".notplayed").remove()
                }
        }
        // Called when player is ready
        function onPlayerReady(event) {
            window.player = event.target;
            //setTimeout(()=>{window.player.cuePlaylist("PL5Pk318UKwyKd2ehcr0qHDsqNRmdyVgAV",0,0);}, 500)
            window.player.setShuffle(true);
            window.player.setLoop(true);
            window.player.playVideo(); // attempt autoplay
            setInterval(() => {
                Array.from(document.querySelectorAll(".prog")).forEach(prog => {
                    if ([1, 2].includes(player.getPlayerState())) {
                        prog.setAttribute("min", 0)
                        prog.setAttribute("max", player.getDuration())
                        prog.setAttribute("value", player.getCurrentTime())

                    }
                    else {
                        prog.removeAttribute("min")
                        prog.removeAttribute("max")
                        prog.removeAttribute("value")
                    }
                })

            }, 500)
        }
    function onPlayerError(event) {
        console.log(event)
        // This function will be called if an error occurs
        const errorCode = event.data;

        if (errorCode === 101 || errorCode === 150) {
            console.log("Error: This video cannot be played in an embedded player.");
            // You can display a message to the user or take other actions
        } else {
            console.log("An unknown error occurred:", errorCode);
        }
    }
        // Called on state changes
        async function onStateChange(event) {
            console.log("Player state:", player.getPlayerState());
            dUrl = new URL("http://files.novafurry.win/.ytprox.php")
            searchp = new URLSearchParams()
            searchp.set("v", player.getVideoData().video_id)
            document.body.style.setProperty('--alb', `url(https://i.ytimg.com/vi/${player.getVideoData().video_id}/maxresdefault.jpg)`)
            dUrl.search = searchp
            console.log(dUrl.href, searchp)
            data = await fetch(dUrl)
            dataEl = document.createElement("html")
            dataEl.innerHTML = await data.text()
            console.log(dataEl)
            //console.log(dataEl.querySelectorAll("span"))
            //console.log(dataEl.querySelector('span[itemprop]')).getAttribute("content").replace(" - Topic", "").trim()
            Array.from(document.querySelectorAll(".data .title")).forEach(el => { el.textContent = player.videoTitle })
            Array.from(document.querySelectorAll(".data .artist")).forEach(el => { el.textContent = dataEl.querySelector('[itemprop="author"] [itemprop="name"]').getAttribute("content").replace(" - Topic", "").trim() })
            if (player.getPlayerState() == 2 || player.getPlayerState() == 5) {
                onPPause()
            }
            else if (![-1, 3, 5].includes(player.getPlayerState())) {
                onPPlay()
            }
            if(player.getPlayerState() == 1){
                onPPlay()
            }
            if(player.getPlayerState() == -1){
                document.querySelector(".tv .notification").innerText = `Skipped "${player.videoTitle}": embedding blocked by copyright holder.`
                document.querySelector(".tv .notification").classList.add("visible")
                setTimeout(()=>{document.querySelector(".tv .notification").classList.remove("visible")}, 5000)
                player.nextVideo()
            }
        }

        async function addPlaylist(id) {
            dUrl = new URL("https://corsproxy.io/")
            ytU = new URL("http://youtube.com/playlist")
            ytuS = new URLSearchParams()
            ytuS.set("list", id)
            ytU.search = ytuS
            searchp = new URLSearchParams()
            searchp.set("url", ytU)
            dUrl.search = searchp

            d = await (await fetch(dUrl)).text()
            data = document.createElement("html")
            data.innerHTML = d
            image = data.querySelector("meta[property='og:image']").getAttribute("content")
            title = data.querySelector("meta[property='og:title']").getAttribute("content")
            li = document.createElement("li")
            img = document.createElement("img")
            img.setAttribute("src", image)
            tit = document.createElement("span")
            tit.innerText = title
            li.appendChild(img)
            li.appendChild(tit)
            li.onclick = () => {
                document.querySelector(".loader").classList.add("loading")
                window.player.cuePlaylist({
                    listType: "playlist",
                    list: id,
                });
                setTimeout(() => {
                    window.player.cuePlaylist({
                        listType: "playlist",
                        list: id,
                    });
                }, 500)
                setTimeout(() => { player.playVideo(); onPPlay() }, 1000)
            }
            document.querySelector(".playlists").appendChild(li)
        }
        addPlaylist("PL6Xd2-6eicQqThEJFnkH-z8CYRlZ5Yjmj")
        addPlaylist("PL5Pk318UKwyKd2ehcr0qHDsqNRmdyVgAV")

        function remoteToggleFc(ev) {
		console.log(ev.target.tagName)
		if (ev.target.tagName !== "BUTTON" && ev.target.tagName !== "INPUT") {
	                document.querySelector('.remote').classList.toggle('fcplayer')
        	}
        }
        document.querySelector(".playerbar").addEventListener("click", remoteToggleFc)
        document.querySelector(".fc").addEventListener("click", remoteToggleFc)
        setInterval(() => {
            document.querySelector(".time").innerText = (new Date()).toLocaleTimeString().toUpperCase()
            document.querySelector(".date").innerText = (new Date()).toLocaleDateString().toUpperCase()

        }, 1000)
    </script>
</body>

</html>
